<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>The Void Walker - لعبة المستكشف</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; touch-action: none; }
        #ui { position: absolute; top: 20px; right: 20px; color: #fff; pointer-events: none; text-shadow: 0 0 10px #0ff; z-index: 10; }
        h1 { margin: 0; font-size: 24px; letter-spacing: 2px; }
        p { font-size: 16px; opacity: 0.8; }
        #story-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; color: white; background: rgba(0,0,0,0.8); padding: 40px;
            border: 1px solid #0ff; box-shadow: 0 0 30px #0ff; border-radius: 10px;
            display: flex; flex-direction: column; align-items: center; z-index: 20;
        }
        #start-btn {
            background: transparent; border: 2px solid #0ff; color: #0ff; padding: 10px 30px;
            font-size: 18px; cursor: pointer; margin-top: 20px; transition: 0.3s;
            text-transform: uppercase; font-weight: bold;
        }
        #start-btn:hover { background: #0ff; color: #000; box-shadow: 0 0 20px #0ff; }
        
        /* Joystick for Mobile */
        #joystick-zone {
            position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.1); border-radius: 50%; border: 2px solid rgba(0, 255, 255, 0.3);
            display: none; /* Shown via JS on touch devices */
            touch-action: none;
        }
        #joystick-knob {
            width: 50px; height: 50px; background: rgba(0, 255, 255, 0.8); border-radius: 50%;
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            box-shadow: 0 0 15px #0ff;
        }
    </style>
</head>
<body>

    <div id="ui">
        <h1>THE VOID WALKER</h1>
        <p>الهدف: اجمع <span id="score">0</span> / 5 مكعبات ذهبية</p>
    </div>

    <div id="story-overlay">
        <h2>قصة اللعبة</h2>
        <p style="line-height: 1.6; max-width: 400px;">
            لقد استيقظت في "عالم الفراغ". لا توجد ملامح بشرية هنا، فقط هندسة معمارية غريبة.
            تقول الأسطورة أن هناك 5 قطع ذهبية تحتوي على طاقة الحياة.
            <br><br>
            <strong>اجمعها لتعيد بناء الواقع.</strong>
        </p>
        <button id="start-btn">ابدأ الرحلة</button>
    </div>

    <div id="joystick-zone"><div id="joystick-knob"></div></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplex-noise/2.4.0/simplex-noise.min.js"></script>

    <script>
        // --- إعدادات اللعبة ---
        let scene, camera, renderer;
        let cubes = [], targets = [];
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
        let prevTime = performance.now();
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let score = 0;
        let isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        // --- إعدادات العالم ---
        const worldWidth = 100;
        const worldDepth = 100;
        
        init();
        animate();

        function init() {
            // 1. إنشاء المشهد
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050510); // لون خلفية داكن
            scene.fog = new THREE.FogExp2(0x050510, 0.035); // ضباب كثيف للغموض

            // 2. الكاميرا
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.y = 2; // ارتفاع اللاعب

            // 3. الإضاءة (سر الروعة)
            const ambientLight = new THREE.HemisphereLight(0xeeeeff, 0x777788, 0.5);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffaa00, 0.8); // ضوء شمس برتقالي
            dirLight.position.set(50, 50, 50);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 2048; // ظل عالي الجودة
            dirLight.shadow.mapSize.height = 2048;
            scene.add(dirLight);

            // ضوء نيون من الأسفل
            const pointLight = new THREE.PointLight(0x00ffff, 1, 20);
            camera.add(pointLight);
            scene.add(camera);

            // 4. بناء العالم (Floor & Cubes)
            const geometry = new THREE.BoxGeometry(1, 1, 1);
            
            // مادة المكعبات (شادر واقعي)
            const material = new THREE.MeshStandardMaterial({
                color: 0x222222,
                roughness: 0.1,
                metalness: 0.8,
            });

            // مادة الحواف (للتصميم الجميل)
            const lineMaterial = new THREE.LineBasicMaterial({ color: 0x00ffff, transparent: true, opacity: 0.3 });

            // الأرضية
            const floorGeo = new THREE.PlaneGeometry(200, 200);
            const floorMat = new THREE.MeshStandardMaterial({ color: 0x111111, roughness: 0.8 });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);

            // توليد عشوائي للمباني
            for (let i = 0; i < 400; i++) {
                const mesh = new THREE.Mesh(geometry, material);
                
                // موقع عشوائي
                mesh.position.x = (Math.random() - 0.5) * 100;
                mesh.position.z = (Math.random() - 0.5) * 100;
                
                // حجم عشوائي (ناطحات سحاب)
                const height = Math.random() * 10 + 1;
                mesh.scale.set(Math.random() * 2 + 1, height, Math.random() * 2 + 1);
                mesh.position.y = height / 2;

                mesh.castShadow = true;
                mesh.receiveShadow = true;
                
                // إضافة حواف جميلة
                const edges = new THREE.EdgesGeometry(geometry);
                const line = new THREE.LineSegments(edges, lineMaterial);
                mesh.add(line); // ربط الحواف بالمكعب

                scene.add(mesh);
                cubes.push(mesh);
            }

            // توليد الأهداف (المكعبات الذهبية)
            const targetGeo = new THREE.OctahedronGeometry(0.5);
            const targetMat = new THREE.MeshStandardMaterial({ 
                color: 0xffd700, 
                emissive: 0xffa500,
                emissiveIntensity: 1,
                roughness: 0,
                metalness: 1
            });

            for(let i=0; i<5; i++) {
                const target = new THREE.Mesh(targetGeo, targetMat);
                target.position.set((Math.random() - 0.5) * 60, 1, (Math.random() - 0.5) * 60);
                
                // ضوء خاص للهدف
                const tLight = new THREE.PointLight(0xffa500, 2, 5);
                target.add(tLight);
                
                scene.add(target);
                targets.push(target);
            }

            // 5. الريندر (المُصير)
            renderer = new THREE.WebGLRenderer({ antialias: true }); // حواف ناعمة
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // 6. التحكم
            setupControls();

            window.addEventListener('resize', onWindowResize);
        }

        // --- منطق التحكم (كمبيوتر + موبايل) ---
        function setupControls() {
            const startBtn = document.getElementById('start-btn');
            const overlay = document.getElementById('story-overlay');
            const joystickZone = document.getElementById('joystick-zone');

            startBtn.addEventListener('click', () => {
                overlay.style.display = 'none';
                
                // تفعيل الماوس للكمبيوتر
                if (!isMobile) {
                    document.body.requestPointerLock();
                } else {
                    // تفعيل الجويستيك للموبايل
                    joystickZone.style.display = 'block';
                    initTouchControls();
                }
            });

            // كيبورد للكمبيوتر
            document.addEventListener('keydown', (event) => {
                switch (event.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = true; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = true; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = true; break;
                    case 'ArrowRight': case 'KeyD': moveRight = true; break;
                }
            });
            document.addEventListener('keyup', (event) => {
                switch (event.code) {
                    case 'ArrowUp': case 'KeyW': moveForward = false; break;
                    case 'ArrowLeft': case 'KeyA': moveLeft = false; break;
                    case 'ArrowDown': case 'KeyS': moveBackward = false; break;
                    case 'ArrowRight': case 'KeyD': moveRight = false; break;
                }
            });

            // حركة الماوس (دوران الكاميرا)
            document.addEventListener('mousemove', (event) => {
                if (document.pointerLockElement === document.body) {
                    camera.rotation.y -= event.movementX * 0.002;
                    camera.rotation.x -= event.movementY * 0.002;
                    // تقييد النظر للأعلى والأسفل
                    camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x));
                }
            });
        }

        // تحكم اللمس (موبايل)
        function initTouchControls() {
            const joyZone = document.getElementById('joystick-zone');
            const joyKnob = document.getElementById('joystick-knob');
            let joyStartX, joyStartY;
            let touchId = null;

            // حركة الجويستيك (المشي)
            joyZone.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.changedTouches[0];
                touchId = touch.identifier;
                joyStartX = touch.clientX;
                joyStartY = touch.clientY;
            }, {passive: false});

            joyZone.addEventListener('touchmove', (e) => {
                e.preventDefault();
                for (let i = 0; i < e.changedTouches.length; i++) {
                    if (e.changedTouches[i].identifier === touchId) {
                        const touch = e.changedTouches[i];
                        let dx = touch.clientX - joyStartX;
                        let dy = touch.clientY - joyStartY;
                        
                        // تحديد مسافة الجويستيك
                        const distance = Math.min(Math.sqrt(dx*dx + dy*dy), 35);
                        const angle = Math.atan2(dy, dx);
                        
                        const mx = Math.cos(angle) * distance;
                        const my = Math.sin(angle) * distance;

                        joyKnob.style.transform = `translate(calc(-50% + ${mx}px), calc(-50% + ${my}px))`;

                        // تحويل حركة الجويستيك إلى حركة لاعب
                        moveForward = my < -10;
                        moveBackward = my > 10;
                        moveLeft = mx < -10;
                        moveRight = mx > 10;
                    }
                }
            }, {passive: false});

            joyZone.addEventListener('touchend', (e) => {
                moveForward = moveBackward = moveLeft = moveRight = false;
                joyKnob.style.transform = `translate(-50%, -50%)`;
            });

            // دوران الكاميرا (لمس الشاشة في أي مكان آخر)
            let lastTouchX = 0;
            document.addEventListener('touchstart', (e) => {
                 // تجاهل لمس الجويستيك
                if (e.target.id !== 'joystick-knob' && e.target.id !== 'joystick-zone') {
                    lastTouchX = e.touches[0].clientX;
                }
            });

            document.addEventListener('touchmove', (e) => {
                if (e.target.id !== 'joystick-knob' && e.target.id !== 'joystick-zone') {
                    const touchX = e.touches[0].clientX;
                    const deltaX = touchX - lastTouchX;
                    camera.rotation.y -= deltaX * 0.005;
                    lastTouchX = touchX;
                }
            });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // --- حلقة اللعبة (Animation Loop) ---
        function animate() {
            requestAnimationFrame(animate);

            const time = performance.now();
            const delta = (time - prevTime) / 1000;

            // 1. فيزياء الحركة
            velocity.x -= velocity.x * 10.0 * delta;
            velocity.z -= velocity.z * 10.0 * delta;

            direction.z = Number(moveForward) - Number(moveBackward);
            direction.x = Number(moveRight) - Number(moveLeft);
            direction.normalize(); // لتوحيد السرعة في الاتجاهات القطرية

            if (moveForward || moveBackward) velocity.z -= direction.z * 400.0 * delta;
            if (moveLeft || moveRight) velocity.x -= direction.x * 400.0 * delta;

            // تطبيق الحركة بناءً على اتجاه الكاميرا
            const rotation = camera.rotation.y;
            const dx = velocity.x * delta;
            const dz = velocity.z * delta;

            camera.position.x -= Math.sin(rotation) * dz + Math.cos(rotation) * dx;
            camera.position.z -= Math.cos(rotation) * dz - Math.sin(rotation) * dx;

            // 2. تحريك الأهداف (Animation)
            targets.forEach((target, index) => {
                target.rotation.x += 2 * delta;
                target.rotation.y += 2 * delta;
                // حركة عائمة
                target.position.y = 1 + Math.sin(time * 0.003 + index) * 0.3;

                // التحقق من الجمع (Collision Detection بسيط)
                if (camera.position.distanceTo(target.position) < 2) {
                    scene.remove(target);
                    targets.splice(index, 1);
                    score++;
                    document.getElementById('score').innerText = score;
                    if(score === 5) alert("✨ مبروك! لقد أعدت بناء الواقع! ✨");
                }
            });

            // التحقق من الحدود (عالم لانهائي وهمي) - إعادة اللاعب إذا ابتعد
            if (camera.position.x > 100) camera.position.x = -100;
            if (camera.position.x < -100) camera.position.x = 100;
            if (camera.position.z > 100) camera.position.z = -100;
            if (camera.position.z < -100) camera.position.z = 100;

            prevTime = time;
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
